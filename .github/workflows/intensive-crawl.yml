name: Intensive News Crawler

on:
  schedule:
    - cron: '*/30 * * * *'  # Every 30 minutes
  workflow_dispatch:
    inputs:
      duration_hours:
        description: 'How many hours to run intensive crawling'
        required: false
        default: '2'
        type: string

env:
  TIMEZONE: Asia/Ho_Chi_Minh

jobs:
  intensive-crawl:
    name: Intensive Crawl (Every 30 min)
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check if intensive crawling is needed
      id: check-need
      run: |
        # Check last commit time
        LAST_COMMIT_TIME=$(git log -1 --format="%ct")
        CURRENT_TIME=$(date +%s)
        TIME_DIFF=$((CURRENT_TIME - LAST_COMMIT_TIME))
        HOURS_SINCE_LAST_COMMIT=$((TIME_DIFF / 3600))

        echo "Last commit was $HOURS_SINCE_LAST_COMMIT hours ago"

        # Only run if last update was more than 30 minutes ago
        if [ $TIME_DIFF -gt 1800 ]; then
          echo "need_crawl=true" >> $GITHUB_OUTPUT
          echo "Will perform intensive crawling"
        else
          echo "need_crawl=false" >> $GITHUB_OUTPUT
          echo "Recent update found, skipping intensive crawl"
        fi

    - name: Set up Python
      if: steps.check-need.outputs.need_crawl == 'true'
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install Dependencies
      if: steps.check-need.outputs.need_crawl == 'true'
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -e .

    - name: Configure Git
      if: steps.check-need.outputs.need_crawl == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Bot (Intensive)"
        git config --local core.autocrlf false

    - name: Set Timezone
      if: steps.check-need.outputs.need_crawl == 'true'
      run: |
        sudo timedatectl set-timezone ${{ env.TIMEZONE }}

    - name: Fast Crawl All Programs
      if: steps.check-need.outputs.need_crawl == 'true'
      run: |
        echo "ðŸš€ Starting intensive crawl session..."

        # Crawl all programs quickly
        for program in apcs standard clc; do
          echo "Quick crawling $program..."
          hcmus-crawler --program $program
          echo "$program completed"
        done

        echo "Intensive crawl session finished"

    - name: Check and Commit Changes
      if: steps.check-need.outputs.need_crawl == 'true'
      run: |
        timestamp=$(TZ="${{ env.TIMEZONE }}" date '+%Y-%m-%d %H:%M %Z')

        # Check for any changes
        if ! git diff --quiet HEAD -- NEWS-*.md; then
          echo "Changes detected, committing..."
          git add NEWS-*.md
          git commit -m "Intensive update: $timestamp

          Quick news refresh
          - APCS, Standard, CLC programs
          - Auto-generated via intensive crawler"
          git push
          echo "Changes pushed successfully"
        else
          echo "No new changes to commit"
        fi

  # Optional: Disable intensive crawling after certain time
  cleanup:
    name: Cleanup Intensive Mode
    runs-on: ubuntu-latest
    needs: intensive-crawl
    if: always() && github.event_name == 'workflow_dispatch'

    steps:
    - name: Report Completion
      run: |
        echo "Intensive crawling session completed"
        echo "Duration: ${{ github.event.inputs.duration_hours || '2' }} hours"
        echo "Check the repository for latest news updates"
