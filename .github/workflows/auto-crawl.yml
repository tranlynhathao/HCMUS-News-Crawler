name: Auto News Crawler

on:
  schedule:
    - cron: '0 */1 * * *'  # Every hour
  workflow_dispatch:  # Allow manual trigger for testing
  push:
    branches: [ master, main ]
    paths-ignore:
      - 'NEWS-*.md'
      - 'README.md'
      - 'USAGE.md'
      - 'docs/**'

env:
  TIMEZONE: Asia/Ho_Chi_Minh

jobs:
  crawl-all-programs:
    name: Crawl All HCMUS Programs
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Install Package in Editable Mode
      run: |
        pip install -e .

    - name: Configure Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Bot"
        git config --local core.autocrlf false

    - name: Set Timezone
      run: |
        sudo timedatectl set-timezone ${{ env.TIMEZONE }}

    - name: Crawl APCS Program
      run: |
        echo "Crawling APCS..."
        hcmus-crawler --program apcs --verbose
        echo "APCS crawling completed"

    - name: Crawl Standard Program
      run: |
        echo "Crawling Standard Program..."
        hcmus-crawler --program standard --verbose
        echo "Standard Program crawling completed"

    - name: Crawl CLC Program
      run: |
        echo "Crawling CLC Program..."
        hcmus-crawler --program clc --verbose
        echo "CLC Program crawling completed"

    - name: Check for Changes
      id: verify-changes
      run: |
        echo "Checking for changes in all news files..."

        CHANGED_FILES=""
        TOTAL_CHANGES=0

        for program in apcs standard clc; do
          OUTPUT_FILE="NEWS-${program^^}.md"
          if ! git diff --quiet HEAD -- "$OUTPUT_FILE" 2>/dev/null; then
            echo "Changes detected in $OUTPUT_FILE"
            CHANGED_FILES="$CHANGED_FILES $OUTPUT_FILE"
            TOTAL_CHANGES=$((TOTAL_CHANGES + 1))
            git diff --stat HEAD -- "$OUTPUT_FILE"
          else
            echo "No changes in $OUTPUT_FILE"
          fi
        done

        echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT
        echo "total_changes=$TOTAL_CHANGES" >> $GITHUB_OUTPUT

        if [ $TOTAL_CHANGES -gt 0 ]; then
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "Total files with changes: $TOTAL_CHANGES"
        else
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "No changes detected in any news files"
        fi

    - name: Commit and Push All Changes
      if: steps.verify-changes.outputs.changes == 'true'
      run: |
        timestamp=$(TZ="${{ env.TIMEZONE }}" date '+%Y-%m-%d %H:%M %Z')

        echo "Staging all changed files..."
        git add NEWS-*.md

        echo "Creating commit..."
        git commit -m "Auto-update all programs news: $timestamp

        Summary:
        - Updated ${{ steps.verify-changes.outputs.total_changes }} program(s)
        - Files: ${{ steps.verify-changes.outputs.changed_files }}
        - Generated at: $timestamp"

        echo "Pushing changes to repository..."
        git push

        echo "Successfully updated news for all programs!"

    - name: Summary Report
      if: always()
      run: |
        echo "Crawling Summary Report"
        echo "========================="
        echo "Execution time: $(TZ="${{ env.TIMEZONE }}" date '+%Y-%m-%d %H:%M %Z')"
        echo "Programs crawled: APCS, Standard, CLC"
        if [ "${{ steps.verify-changes.outputs.changes }}" = "true" ]; then
          echo "Changes detected: YES"
          echo "Files updated: ${{ steps.verify-changes.outputs.total_changes }}"
          echo "Updated files: ${{ steps.verify-changes.outputs.changed_files }}"
        else
          echo "Changes detected: NO"
          echo "ℹ️  All news files are up to date"
        fi
        echo "========================="

  failure-notification:
    name: Handle Failures
    runs-on: ubuntu-latest
    needs: crawl-all-programs
    if: failure()

    steps:
    - name: Log Failure
      run: |
        echo "Automated crawling failed at $(TZ=Asia/Ho_Chi_Minh date)"
